{% extends "layout.html" %}
{% block title %}{{ _('customer_portal_title') }}{% endblock %}
{% block content %}
<section class="space-y-10">
  <div class="rounded-3xl bg-gradient-to-br from-primary to-indigo-700 text-white p-8 lg:p-12 shadow-soft">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-4">
        <p class="text-sm uppercase tracking-[0.3em] text-white/70">{{ _('welcome_back') }}</p>
        <h1 class="text-3xl lg:text-4xl font-extrabold leading-tight">
          {{ _('shipping_hub_ready') }}
        </h1>
        <p class="text-sm lg:text-base text-white/80 max-w-2xl">
          {{ _('track_shipments_paragraph') }}
        </p>
        {% if outstanding_total and outstanding_total > 0 %}
          <div class="inline-flex items-center gap-3 rounded-full bg-white/10 px-4 py-2 text-sm font-semibold">
            <span class="inline-flex h-2 w-2 rounded-full bg-amber-300 animate-pulse"></span>
            {{ _('outstanding_balance_label') }}
            <span>{{ '%.3f'|format(outstanding_total) }} {{ _('currency_omr') }}</span>
          </div>
        {% endif %}
      </div>
      <div class="grid gap-3 sm:grid-cols-2">
        <a href="{{ url_for('cust.my_cars') }}" class="inline-flex items-center gap-3 rounded-2xl bg-white/10 px-5 py-4 text-sm font-semibold shadow-sm hover:bg-white/20 transition">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/20"><i class="fa-solid fa-car"></i></span>
          <span>{{ _('my_vehicles') }}</span>
        </a>
        <a href="{{ url_for('cust.track') }}" class="inline-flex items-center gap-3 rounded-2xl bg-white/10 px-5 py-4 text-sm font-semibold shadow-sm hover:bg-white/20 transition">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/20"><i class="fa-solid fa-location-arrow"></i></span>
          <span>{{ _('track_shipment') }}</span>
        </a>
        <a href="{{ url_for('cust.invoices_list') }}" class="inline-flex items-center gap-3 rounded-2xl bg-white/10 px-5 py-4 text-sm font-semibold shadow-sm hover:bg-white/20 transition">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/20"><i class="fa-solid fa-file-invoice-dollar"></i></span>
          <span>{{ _('invoices') }}</span>
        </a>
        <a href="{{ url_for('pricing_request') }}" class="inline-flex items-center gap-3 rounded-2xl bg-white/10 px-5 py-4 text-sm font-semibold shadow-sm hover:bg-white/20 transition">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/20"><i class="fa-solid fa-headset"></i></span>
          <span>{{ _('support_request') }}</span>
        </a>
      </div>
    </div>

    <form method="get" action="{{ url_for('cust.track') }}" class="mt-10 grid gap-3 sm:grid-cols-[1fr_auto]">
      <input name="vin" required placeholder="{{ _('enter_vin_placeholder') }}" class="w-full rounded-2xl border border-white/20 bg-white/20 px-4 py-3 text-sm backdrop-blur focus:border-white focus:outline-none focus:ring-2 focus:ring-white/60" />
      <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-white px-5 py-3 text-sm font-semibold text-primary hover:bg-slate-100 transition">
        <i class="fa-solid fa-magnifying-glass"></i>
        {{ _('search_tracking') }}
      </button>
    </form>
  </div>

  <!-- KPI cards -->
  <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-5">
    <article class="rounded-2xl bg-white p-5 shadow-soft border border-slate-100">
      <p class="text-xs uppercase tracking-widest text-muted">{{ _('total_vehicles') }}</p>
      <p class="mt-3 text-3xl font-bold text-neutral">{{ counts.total }}</p>
    </article>
    <article class="rounded-2xl bg-white p-5 shadow-soft border border-slate-100">
      <p class="text-xs uppercase tracking-widest text-blue-600">{{ _('in_transit') }}</p>
      <p class="mt-3 text-3xl font-bold text-blue-600">{{ counts.in_transit }}</p>
    </article>
    <article class="rounded-2xl bg-white p-5 shadow-soft border border-slate-100">
      <p class="text-xs uppercase tracking-widest text-emerald-600">{{ _('arrived_delivered') }}</p>
      <p class="mt-3 text-3xl font-bold text-emerald-600">{{ counts.delivered }}</p>
    </article>
    <article class="rounded-2xl bg-white p-5 shadow-soft border border-slate-100">
      <p class="text-xs uppercase tracking-widest text-amber-600">{{ _('awaiting_pickup') }}</p>
      <p class="mt-3 text-3xl font-bold text-amber-600">{{ counts.awaiting }}</p>
    </article>
    <article class="rounded-2xl bg-white p-5 shadow-soft border border-slate-100">
      <p class="text-xs uppercase tracking-widest text-primary">{{ _('Open invoices') }}</p>
      <p class="mt-3 text-3xl font-bold text-primary">{{ counts.open_invoices }}</p>
    </article>
  </div>

  <div class="grid gap-6 xl:grid-cols-3">
    <section class="xl:col-span-2 rounded-2xl bg-white p-6 shadow-soft border border-slate-100">
      <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-neutral">{{ _('Recent vehicles') }}</h2>
          <p class="text-sm text-muted">{{ _('We highlight the latest vehicles you added or purchased. Use the actions to see full details.') }}</p>
        </div>
        <a href="{{ url_for('cust.my_cars') }}" class="text-xs font-semibold uppercase tracking-widest text-primary hover:text-primary/80">
          {{ _('View all') }} <i class="fa-solid fa-arrow-up-right-from-square ms-1"></i>
        </a>
      </div>

      {% if vehicles %}
        <div class="mt-6 space-y-4">
          {% for vehicle in vehicles %}
            <article class="rounded-2xl border border-slate-100 p-5 shadow-soft hover:shadow-lg transition">
              <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                <div class="space-y-2">
                  <p class="text-xs uppercase tracking-widest text-muted">{{ _('VIN') }}</p>
                  <p class="font-mono text-sm text-neutral">{{ vehicle.vin or '-' }}</p>
                  <h3 class="text-lg font-semibold text-neutral">{{ vehicle.title or _('Unnamed vehicle') }}</h3>
                  <p class="text-sm text-muted">{{ _('Current status:') }} <span class="font-semibold text-neutral">{{ vehicle.status }}</span></p>
                  <dl class="grid gap-x-6 gap-y-2 text-sm sm:grid-cols-2">
                    <div class="flex items-center gap-2">
                      <dt class="text-muted">{{ _('Container') }}</dt>
                      <dd class="font-semibold text-neutral">{{ vehicle.container or '-' }}</dd>
                    </div>
                    <div class="flex items-center gap-2">
                      <dt class="text-muted">{{ _('Route') }}</dt>
                      <dd class="font-semibold text-neutral">
                        {% if vehicle.origin or vehicle.destination %}
                          {{ vehicle.origin or '—' }} → {{ vehicle.destination or '—' }}
                        {% else %}
                          {{ _('Pending assignment') }}
                        {% endif %}
                      </dd>
                    </div>
                    <div class="flex items-center gap-2">
                      <dt class="text-muted">{{ _('Departed') }}</dt>
                      <dd class="font-semibold text-neutral">
                        {% if vehicle.departed %}{{ vehicle.departed.strftime('%d %b %Y') }}{% else %}{{ _('Waiting') }}{% endif %}
                      </dd>
                    </div>
                    <div class="flex items-center gap-2">
                      <dt class="text-muted">{{ _('ETA') }}</dt>
                      <dd class="font-semibold text-neutral">
                        {% if vehicle.eta %}{{ vehicle.eta.strftime('%d %b %Y') }}{% else %}{{ _('awaiting_update') }}{% endif %}
                      </dd>
                    </div>
                  </dl>
                </div>
                <div class="flex flex-col items-start gap-3 min-w-[160px]">
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold
                    {% if vehicle.stage == 'in_transit' %}
                      bg-blue-100 text-blue-700
                    {% elif vehicle.stage == 'delivered' %}
                      bg-emerald-100 text-emerald-700
                    {% else %}
                      bg-amber-100 text-amber-700
                    {% endif %}">
                    <span class="inline-flex h-2 w-2 rounded-full
                      {% if vehicle.stage == 'in_transit' %}
                        bg-blue-500
                      {% elif vehicle.stage == 'delivered' %}
                        bg-emerald-500
                      {% else %}
                        bg-amber-500
                      {% endif %}">
                    </span>
                    {% if vehicle.stage == 'in_transit' %}
                      {{ _('in_transit') }}
                    {% elif vehicle.stage == 'delivered' %}
                      {{ _('delivered') }}
                    {% else %}
                      {{ _('waiting_to_ship') }}
                    {% endif %}
                  </span>
                  <a href="{{ vehicle.timeline_url or url_for('cust.track') }}{% if vehicle.timeline_url %}{% else %}?vin={{ vehicle.vin }}{% endif %}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold hover:border-primary hover:text-primary transition">
                    <i class="fa-solid fa-route"></i>
                    {{ _('track_timeline') }}
                  </a>
                  <a href="{{ vehicle.details_url }}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold hover:border-primary hover:text-primary transition">
                    <i class="fa-solid fa-file-lines"></i>
                    {{ _('vehicle_details') }}
                  </a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="mt-6 rounded-xl border border-dashed border-slate-200 bg-slate-50 p-6 text-center text-sm text-muted">
          {{ _('no_vehicles_message') }}
        </div>
      {% endif %}
    </section>

    <section class="rounded-2xl bg-white p-6 shadow-soft border border-slate-100">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-neutral">{{ _('invoices_billing') }}</h2>
          <p class="text-sm text-muted">{{ _('invoices_intro') }}</p>
        </div>
        <a href="{{ url_for('cust.invoices_list') }}" class="text-xs font-semibold uppercase tracking-widest text-primary hover:text-primary/80">
          {{ _('manage_invoices') }}
        </a>
      </div>

      {% if invoices %}
        <ul class="mt-6 space-y-4">
          {% for invoice in invoices %}
            <li class="rounded-2xl border border-slate-100 p-4 shadow-soft">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <p class="text-xs uppercase tracking-widest text-muted">{{ _('invoice_label') }} {{ invoice.number }}</p>
                  <p class="mt-1 text-sm text-neutral">
                    {% if invoice.created_at %}{{ invoice.created_at.strftime('%d %b %Y') }}{% endif %}
                  </p>
                  <p class="mt-2 text-sm text-muted">
                    {{ _('total_label') }}
                    <span class="font-semibold text-neutral">{{ '%.3f'|format(invoice.total) }} {{ _('currency_omr') }}</span>
                  </p>
                  {% if invoice.is_open %}
                    <p class="text-sm text-amber-600 font-semibold mt-1">
                      {{ _('outstanding_label') }} {{ '%.3f'|format(invoice.outstanding) }} {{ _('currency_omr') }}
                    </p>
                  {% else %}
                    <p class="text-sm text-emerald-600 font-semibold mt-1">{{ _('paid_in_full') }}</p>
                  {% endif %}
                </div>
                <div class="flex flex-col items-end gap-2">
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold
                    {% if invoice.is_open %}
                      bg-amber-100 text-amber-700
                    {% else %}
                      bg-emerald-100 text-emerald-700
                    {% endif %}">
                    <span class="inline-flex h-2 w-2 rounded-full
                      {% if invoice.is_open %}
                        bg-amber-500
                      {% else %}
                        bg-emerald-500
                      {% endif %}">
                    </span>
                    {% if invoice.is_open %}
                      {{ _('open_status') }}
                    {% else %}
                      {{ _('paid_status') }}
                    {% endif %}
                  </span>
                  <a href="{{ invoice.detail_url }}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold hover:border-primary hover:text-primary transition">
                    <i class="fa-solid fa-file-lines"></i>
                    {{ _('view_invoice') }}
                  </a>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="mt-6 rounded-xl border border-dashed border-slate-200 bg-slate-50 p-6 text-center text-sm text-muted">
          {{ _('invoices_empty_message') }}
        </div>
      {% endif %}
    </section>
  </div>

  <section class="rounded-3xl bg-white p-6 shadow-soft border border-slate-100">
    <div class="grid gap-6 md:grid-cols-3">
      <div class="space-y-3">
        <h3 class="text-lg font-semibold text-neutral">{{ _('need_assistance') }}</h3>
        <p class="text-sm text-muted">
          {{ _('assistance_description') }}
        </p>
      </div>
      <div class="flex flex-col gap-3">
        <a href="mailto:{{ customer.email if customer else 'support@example.com' }}" class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 px-4 py-3 text-sm font-semibold hover:border-primary hover:text-primary transition">
          <i class="fa-solid fa-envelope"></i>
          {{ _('email_us') }}
        </a>
        <a href="tel:{{ customer.phone if customer and customer.phone else '+96800000000' }}" class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 px-4 py-3 text-sm font-semibold hover:border-primary hover:text-primary transition">
          <i class="fa-solid fa-phone"></i>
          {{ _('call_support') }}
        </a>
      </div>
      <div class="flex flex-col gap-3">
        <a href="{{ url_for('pricing_request') }}" class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 px-4 py-3 text-sm font-semibold hover:border-primary hover:text-primary transition">
          <i class="fa-solid fa-clipboard-list"></i>
          {{ _('request_shipment_quote') }}
        </a>
        <a href="{{ url_for('cust.track') }}" class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 px-4 py-3 text-sm font-semibold hover:border-primary hover:text-primary transition">
          <i class="fa-solid fa-map-location-dot"></i>
          {{ _('track_another_vehicle') }}
        </a>
      </div>
    </div>
  </section>
</section>
{% endblock %}
