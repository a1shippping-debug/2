{% macro vehicle_card(v, index=0, cta='details', show_share=false) %}
  {% set title = ((v.make or '-') ~ ' ' ~ (v.model or '') ~ ' ' ~ (v.year or ''))|trim %}
  {# Prefer sale price (OMR) if available; fallback to purchase (USD)
     Use default(None, true) so missing attribute doesn't error #}
  {% set price_sale = v.sale_price_omr|default(None, true) %}
  {% set has_sale = price_sale is not none and price_sale != '' %}
  {% set price_label = _('سعر البيع') if has_sale else _('سعر الشراء (تقريبي)') %}
  {% set price_value = price_sale if has_sale else v.purchase_price_usd %}
  {#
    cta options:
    - 'details': public tracking page (timeline)
    - 'public_details': public vehicle details by VIN (no tracking)
    - 'cust_details': customer details page (no tracking)
    - 'edit': operations edit page
  #}
  {% if cta=='details' %}
    {% set details_url = url_for('tracking_page', vin=v.vin) %}
  {% elif cta=='public_details' %}
    {% set details_url = url_for('vehicle_detail_page', vin=v.vin) %}
  {% elif cta=='cust_details' %}
    {% set details_url = url_for('cust.car_detail', vehicle_id=v.id) %}
  {% else %}
    {% set details_url = url_for('ops.cars_edit', vehicle_id=v.id) %}
  {% endif %}
  <article class="group bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden transform transition will-change-transform hover:scale-[1.03] hover:shadow-lg animate-fadeInUp" style="animation-delay: {{ (index * 90) | int }}ms">
    <div class="relative aspect-[4/3] bg-background overflow-hidden">
      <img loading="lazy" src="{{ v.primary_image_url or url_for('static', filename='logo.jpeg') }}" data-full="{{ v.primary_image_url or url_for('static', filename='logo.jpeg') }}" alt="{{ title }}" class="w-full h-full object-cover transition-opacity duration-700 opacity-0 js-zoomable cursor-zoom-in" onload="this.classList.remove('opacity-0')">
      <div class="absolute inset-0 bg-gradient-to-t from-neutral/50 via-neutral/0 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
      <!-- hover specs -->
      <div class="absolute bottom-0 left-0 right-0 p-3 text-white opacity-0 group-hover:opacity-100 transition-opacity text-xs md:text-sm">
        <div class="flex gap-4 flex-wrap">
          <div><span class="text-white/80">VIN:</span> <span class="font-semibold">{{ v.vin or '-' }}</span></div>
          <div><span class="text-white/80">{{ _('الموقع') }}:</span> <span class="font-semibold">{{ v.current_location or '-' }}</span></div>
          <div><span class="text-white/80">{{ _('الحالة') }}:</span> <span class="font-semibold">{{ v.status or '-' }}</span></div>
        </div>
      </div>
    </div>
    <div class="p-4">
      <h3 class="font-heading font-semibold text-neutral text-base md:text-lg mb-1">{{ title }}</h3>
      <div class="text-muted text-sm mb-2">
        {{ price_label }}:
        <span class="text-neutral font-semibold">
          {% if has_sale %}
            {{ ("OMR %.3f" % price_value) }}
          {% else %}
            {{ ("$%.2f" % price_value) if price_value else '-' }}
          {% endif %}
        </span>
      </div>
      <div class="flex items-center justify-between">
        <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded bg-background text-neutral/80">
          <i class="fa-solid fa-tag text-accent"></i>
          {{ v.status or '-' }}
        </span>
        <div class="flex items-center gap-2">
          {% if show_share %}
          <form method="post" action="{{ url_for('cust.share_vehicle', vehicle_id=v.id) }}" class="js-share-form" data-vehicle-id="{{ v.id }}">
            <button type="submit" class="px-3 py-1.5 rounded-md bg-accent text-neutral text-sm font-medium transition hover:shadow-md hover:scale-105 js-share-btn">
              <i class="fa-solid fa-share-nodes"></i> {{ _('مشاركة') }}
            </button>
          </form>
          {% endif %}
          <a href="{{ details_url }}" class="px-3 py-1.5 rounded-md bg-primary text-white text-sm font-medium transition hover:shadow-md hover:scale-105">
            {% if cta=='edit' %}{{ _('تحديث السيارة') }}{% else %}{{ _('عرض التفاصيل') }}{% endif %}
          </a>
        </div>
      </div>
    </div>
  </article>
{% endmacro %}
