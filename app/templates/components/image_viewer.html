<!-- Global fullscreen image viewer -->
<div id="image-lightbox" class="fixed inset-0 z-[1000] hidden bg-black/90 select-none" aria-hidden="true" role="dialog" aria-label="Image viewer">
  <!-- Controls -->
  <div class="absolute top-4 left-4 flex gap-2">
    <button type="button" class="js-zoom-in px-3 py-2 rounded-md bg-white/10 text-white border border-white/20 hover:bg-white/20">
      <i class="fa-solid fa-magnifying-glass-plus"></i>
    </button>
    <button type="button" class="js-zoom-out px-3 py-2 rounded-md bg-white/10 text-white border border-white/20 hover:bg-white/20">
      <i class="fa-solid fa-magnifying-glass-minus"></i>
    </button>
    <button type="button" class="js-reset px-3 py-2 rounded-md bg-white/10 text-white border border-white/20 hover:bg-white/20">
      <i class="fa-solid fa-rotate-left"></i>
    </button>
  </div>
  <button type="button" class="js-close absolute top-4 right-4 px-3 py-2 rounded-md bg-white/10 text-white border border-white/20 hover:bg-white/20" aria-label="Close">
    <i class="fa-solid fa-xmark"></i>
  </button>

  <!-- Stage -->
  <div class="js-stage w-full h-full overflow-hidden flex items-center justify-center touch-pan-y">
    <img class="js-image max-w-none pointer-events-auto will-change-transform" alt="" draggable="false" />
  </div>
</div>

<script>
(function(){
  if (window.__imageLightboxInitialized) return; // avoid duplicate bindings
  window.__imageLightboxInitialized = true;

  const overlay = document.getElementById('image-lightbox');
  if (!overlay) return;
  const stage = overlay.querySelector('.js-stage');
  const img = overlay.querySelector('.js-image');
  const btnClose = overlay.querySelector('.js-close');
  const btnZoomIn = overlay.querySelector('.js-zoom-in');
  const btnZoomOut = overlay.querySelector('.js-zoom-out');
  const btnReset = overlay.querySelector('.js-reset');

  let isOpen = false;
  let scale = 1;
  let translateX = 0;
  let translateY = 0;
  const MIN_SCALE = 1;
  const MAX_SCALE = 6;
  const ZOOM_STEP = 0.25;

  function applyTransform(){
    img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
  }

  function clampTranslation(){
    const rect = stage.getBoundingClientRect();
    const imgW = (img.naturalWidth || rect.width) * scale;
    const imgH = (img.naturalHeight || rect.height) * scale;
    const maxX = Math.max(0, (imgW - rect.width) / 2);
    const maxY = Math.max(0, (imgH - rect.height) / 2);
    translateX = Math.min(maxX, Math.max(-maxX, translateX));
    translateY = Math.min(maxY, Math.max(-maxY, translateY));
  }

  function openViewer(src, alt){
    if (!src) return;
    img.src = src;
    img.alt = alt || '';
    scale = 1; translateX = 0; translateY = 0; applyTransform();
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    isOpen = true;
    img.focus && img.focus();
  }

  function closeViewer(){
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    img.removeAttribute('src');
    isOpen = false;
  }

  function zoomBy(delta){
    const prev = scale;
    scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale + delta));
    if (scale === MIN_SCALE) { translateX = 0; translateY = 0; }
    else if (scale !== prev) { clampTranslation(); }
    applyTransform();
  }

  // Expose helper
  window.openImageLightbox = openViewer;

  // Buttons
  btnClose.addEventListener('click', closeViewer);
  btnZoomIn.addEventListener('click', () => zoomBy(ZOOM_STEP));
  btnZoomOut.addEventListener('click', () => zoomBy(-ZOOM_STEP));
  btnReset.addEventListener('click', () => { scale = 1; translateX = 0; translateY = 0; applyTransform(); });

  // Close on overlay click (except when clicking the image itself)
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeViewer();
  });

  // Wheel zoom
  stage.addEventListener('wheel', (e) => {
    if (!isOpen) return;
    e.preventDefault();
    const direction = e.deltaY > 0 ? -1 : 1;
    zoomBy(direction * ZOOM_STEP);
  }, { passive: false });

  // Drag to pan
  let dragging = false; let startX = 0; let startY = 0; let startTX = 0; let startTY = 0;
  function canPan(){ return scale > 1; }
  function onPointerDown(x, y){
    if (!isOpen || !canPan()) return;
    dragging = true; startX = x; startY = y; startTX = translateX; startTY = translateY;
    stage.style.cursor = 'grabbing';
  }
  function onPointerMove(x, y){
    if (!dragging) return;
    translateX = startTX + (x - startX);
    translateY = startTY + (y - startY);
    clampTranslation();
    applyTransform();
  }
  function onPointerUp(){ dragging = false; stage.style.cursor = ''; }

  // Mouse
  stage.addEventListener('mousedown', (e)=>{ if (e.button===0) onPointerDown(e.clientX, e.clientY); });
  window.addEventListener('mousemove', (e)=> onPointerMove(e.clientX, e.clientY));
  window.addEventListener('mouseup', onPointerUp);

  // Touch
  stage.addEventListener('touchstart', (e)=>{
    if (e.touches.length === 1) { const t = e.touches[0]; onPointerDown(t.clientX, t.clientY); }
  }, { passive: true });
  stage.addEventListener('touchmove', (e)=>{
    if (e.touches.length === 1) { const t = e.touches[0]; onPointerMove(t.clientX, t.clientY); }
  }, { passive: false });
  stage.addEventListener('touchend', onPointerUp);

  // Double click/tap to toggle zoom
  let lastTap = 0;
  stage.addEventListener('click', ()=>{
    const now = Date.now();
    if (now - lastTap < 300) {
      if (scale === 1) zoomBy(1);
      else { scale = 1; translateX = 0; translateY = 0; applyTransform(); }
    }
    lastTap = now;
  });

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    if (!isOpen) return;
    if (e.key === 'Escape') closeViewer();
    if (e.key === '+' || e.key === '=') { e.preventDefault(); zoomBy(ZOOM_STEP); }
    if (e.key === '-' || e.key === '_') { e.preventDefault(); zoomBy(-ZOOM_STEP); }
    if (e.key === '0') { e.preventDefault(); scale = 1; translateX = 0; translateY = 0; applyTransform(); }
  });

  // Delegated open on click for any image with .js-zoomable or [data-zoomable]
  document.addEventListener('click', (e)=>{
    const target = e.target.closest('img.js-zoomable, img[data-zoomable]');
    if (!target) return;
    e.preventDefault();
    const src = target.getAttribute('data-full') || target.currentSrc || target.src;
    const alt = target.getAttribute('alt') || '';
    openViewer(src, alt);
  });
})();
</script>
