{% set role = (current_user.role.name|lower) if current_user.is_authenticated and current_user.role else 'guest' %}
{% set role_map = {
  'admin': 'admin',
  'manager': 'admin',
  'employee': 'employee',
  'staff': 'employee',
  'employees': 'employee',
  'accountant': 'accountant',
  'customer': 'customer'
} %}
{% set role_name = role_map.get(role, 'guest') %}

{% set nav_by_role = {
  'admin': [
    {'label': _('Admin Dashboard'), 'url': url_for('admin.dashboard')},
    {'label': _('Operations Dashboard'), 'url': url_for('ops.dashboard')},
    {'label': _('Warehouses'), 'url': url_for('ops.warehouses_view')},
    {'label': _('Vehicles'), 'url': url_for('ops.cars_list')},
    {'label': _('Customers'), 'url': url_for('ops.customers_list')},
    {'label': _('Bill of Lading'), 'url': url_for('acct.bol_list')}
  ],
  'employee': [
    {'label': _('Operations Dashboard'), 'url': url_for('ops.dashboard')},
    {'label': _('Warehouses'), 'url': url_for('ops.warehouses_view')},
    {'label': _('Vehicles'), 'url': url_for('ops.cars_list')},
    {'label': _('Shipments'), 'url': url_for('ops.shipments_list')},
    {'label': _('Customers'), 'url': url_for('ops.customers_list')},
    {'label': _('Sale Listings'), 'url': url_for('ops.sale_listings_list')}
  ],
  'accountant': [
    {'label': _('Accounting Dashboard'), 'url': url_for('acct.dashboard')},
    {'label': _('Invoices'), 'url': url_for('acct.invoices_list')},
    {'label': _('Payments'), 'url': url_for('acct.payments_list')},
    {'label': _('Bill of Lading'), 'url': url_for('acct.bol_list')}
  ],
  'customer': [
    {'label': _('Customer Dashboard'), 'url': url_for('cust.dashboard')},
    {'label': _('My Cars'), 'url': url_for('cust.my_cars')},
    {'label': _('Track Shipment'), 'url': url_for('cust.track')},
    {'label': _('My Invoices'), 'url': url_for('cust.invoices_list')}
  ],
  'guest': [
    {'label': _('Home'), 'url': url_for('index')},
    {'label': _('Track Shipment'), 'url': url_for('cust.track')},
    {'label': _('Request Pricing'), 'url': url_for('pricing_request')},
  ]
} %}

{% set nav_links = nav_by_role.get(role_name, nav_by_role['guest']) %}
{% set can_search = role_name in ['admin', 'employee', 'accountant'] %}
{% set user_label = current_user.name if current_user.is_authenticated and current_user.name else role_name.capitalize() %}

<!-- ========== NAVBAR ========== -->
<nav class="fixed top-0 inset-x-0 z-50 bg-gradient-to-b from-[#0B1E3F] to-[#123055] text-white shadow-md"
     style="direction:{{ 'ltr' if language_switch_label == 'English' else 'rtl' }};">

  <div class="max-w-7xl mx-auto px-4"
       x-data="{ open:false, menu:false }"
       x-effect="document.body.style.overflow = open ? 'hidden' : ''">

    <div class="h-16 flex items-center justify-between">

      <!-- LOGO -->
      <a href="/" class="flex items-center gap-2 text-lg font-bold hover:opacity-90">
        <img src="{{ url_for('static', filename='logo.png') }}" class="h-8 w-8 rounded-full object-cover">
      </a>

      <!-- DESKTOP MENU -->
      <div class="hidden md:flex items-center gap-6 text-sm">

        {% for item in nav_links %}
        <a href="{{ item.url }}" class="hover:text-[#FFB838] transition">{{ item.label }}</a>
        {% endfor %}

        <a href="{{ language_switch_url }}" class="px-4 py-1.5 rounded-full border border-white/25 font-semibold hover:text-[#FFB838]">
          {{ language_switch_label }}
        </a>



        <!-- USER AREA -->
        {% if current_user.is_authenticated %}
        <div class="relative" x-data="{menu:false}">
          <button @click="menu=!menu" class="flex items-center gap-2 hover:text-[#FFB838]">
            <i class="fa-regular fa-user text-lg"></i>
            <span class="hidden lg:inline">{{ user_label }}</span>
          </button>

          <div x-show="menu" @click.outside="menu=false" x-transition
            class="absolute right-0 mt-2 w-56 bg-white text-gray-800 rounded-md shadow-lg py-2 text-sm">

            <div class="px-3 py-2">
              {{ _('Signed in as') }} <strong>{{ user_label }}</strong><br>
              <span class="text-xs text-gray-400">{{ role_name }}</span>
            </div>

            <a href="{{ url_for('auth.logout') }}"
               class="block px-3 py-2 text-red-600 hover:bg-gray-100">{{ _('Logout') }}</a>
          </div>
        </div>

        {% else %}

        <a href="{{ url_for('auth.login') }}"
           class="px-4 py-2 rounded-full bg-[#FFB838] text-neutral-900 font-semibold hover:opacity-90">
          {{ _('Login') }}
        </a>

        {% endif %}
      </div>

      <!-- MOBILE BUTTON -->
      <button class="md:hidden p-2 rounded hover:bg-white/10"
              @click="open=!open">
        <i class="fa-solid fa-bars text-xl"></i>
      </button>

    </div>

    <!-- MOBILE MENU -->
    <div x-show="open" x-transition class="md:hidden py-3 bg-[#0B1E3F] border-t border-white/10 rounded-b-xl space-y-2 text-sm">

      {% for item in nav_links %}
      <a href="{{ item.url }}" class="block px-2 py-2 hover:text-[#FFB838]">{{ item.label }}</a>
      {% endfor %}

      <a href="{{ language_switch_url }}" class="block px-2 py-2 font-semibold hover:text-[#FFB838]">
        {{ language_switch_label }}
      </a>

      {% if current_user.is_authenticated %}
      <a href="{{ url_for('auth.logout') }}" class="block text-red-400 font-semibold mt-3 px-2">{{ _('Logout') }}</a>
      {% else %}
      <a href="{{ url_for('auth.login') }}" class="block font-semibold hover:text-[#FFB838] mt-3 px-2">{{ _('Login') }}</a>
      {% endif %}
    </div>

  </div>

</nav>
