{% extends "layout.html" %}
{% block title %}{{ _('Update Vehicle Statuses') }}{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-semibold">{{ _('Update Vehicle Statuses') }}</h1>
  <div class="flex items-center gap-2">
    <a href="{{ url_for('ops.cars_list') }}" class="px-3 py-2 bg-white border rounded">{{ _('Back to Cars') }}</a>
  </div>
</div>

<form method="get" class="bg-white p-4 rounded shadow mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
  <input name="vin" placeholder="{{ _('VIN') }}" value="{{ request.args.get('vin','') }}" class="border p-2 rounded">
  <select name="client_id" class="border p-2 rounded">
    <option value="">{{ _('Client') }}</option>
    {% for c in customers %}
      <option value="{{c.id}}" {% if request.args.get('client_id')==(c.id|string) %}selected{% endif %}>{{ c.display_name }}</option>
    {% endfor %}
  </select>
  <button class="px-3 py-2 bg-gray-800 text-white rounded">{{ _('Filter') }}</button>
</form>

<div class="bg-white rounded shadow overflow-x-auto">
  <form id="statusForm" class="p-3">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-gray-500">
          <th class="py-2 px-3">{{ _('VIN') }}</th>
          <th class="py-2 px-3">{{ _('Make') }}</th>
          <th class="py-2 px-3">{{ _('Model') }}</th>
          <th class="py-2 px-3">{{ _('Client') }}</th>
          <th class="py-2 px-3">{{ _('Current Status') }}</th>
          <th class="py-2 px-3">{{ _('New Status') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for v in cars %}
        <tr class="border-t">
          <td class="py-2 px-3">{{ v.vin }}</td>
          <td class="py-2 px-3">{{ v.make }}</td>
          <td class="py-2 px-3">{{ v.model }}</td>
          <td class="py-2 px-3">{{ v.owner.display_name if v.owner else '-' }}</td>
          <td class="py-2 px-3">{{ v.status or '-' }}</td>
          <td class="py-2 px-3 align-top">
            <select name="status_{{ v.id }}" class="border p-2 rounded w-full" data-vehicle-id="{{ v.id }}">
              {% for s in ['New car','Cashier Payment','Auction Payment','Posted','Towing','Warehouse','Loading','Shipping','Port','On way','Arrived','Delivered'] %}
                <option value="{{s}}" {% if v.status==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            {% set show_shipping_fields = v.status in ['Shipping','Port','On way','Arrived','Delivered'] or v.container_number or v.booking_number or v.shipping_tracking_url %}
            <div class="mt-2 space-y-2 shipping-extra" data-fields-for="{{ v.id }}" data-has-values="{{ 'yes' if (v.container_number or v.booking_number or v.shipping_tracking_url) else 'no' }}" style="{% if show_shipping_fields %}display:block{% else %}display:none{% endif %};">
              <input name="container_{{ v.id }}" value="{{ v.container_number or '' }}" placeholder="{{ _('Container Number') }}" class="border p-2 rounded w-full">
              <input name="booking_{{ v.id }}" value="{{ v.booking_number or '' }}" placeholder="{{ _('Booking Number') }}" class="border p-2 rounded w-full">
              <input name="tracking_{{ v.id }}" value="{{ v.shipping_tracking_url or '' }}" placeholder="{{ _('Shipping tracking link (https://...)') }}" class="border p-2 rounded w-full">
              <p class="text-xs text-slate-500">{{ _('Required when status is Shipping or later') }}</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="p-3">
      <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded">{{ _('Save Changes') }}</button>
      <span id="saveResult" class="ml-3 text-sm"></span>
    </div>
  </form>
</div>

<script>
  const form = document.getElementById('statusForm');
  const result = document.getElementById('saveResult');
  const shippingStages = ['shipping', 'port', 'on way', 'arrived', 'delivered'];

  form.querySelectorAll('select[name^="status"]').forEach((select) => {
    const vid = select.getAttribute('data-vehicle-id');
    if (!vid) return;
    const fields = form.querySelector(`[data-fields-for="${vid}"]`);
    if (!fields) return;
    const updateHasValues = () => {
      const inputs = Array.from(fields.querySelectorAll('input'));
      const anyValue = inputs.some((input) => (input.value || '').trim().length > 0);
      fields.setAttribute('data-has-values', anyValue ? 'yes' : 'no');
      return anyValue;
    };
    const toggle = () => {
      const value = (select.value || '').trim().toLowerCase();
      const hasValues = updateHasValues();
      if (shippingStages.includes(value) || hasValues) {
        fields.style.display = 'block';
      } else {
        fields.style.display = 'none';
      }
    };
    fields.querySelectorAll('input').forEach((input) => {
      input.addEventListener('input', () => {
        const hasAny = updateHasValues();
        if (hasAny && fields.style.display === 'none') {
          fields.style.display = 'block';
        }
      });
    });
    select.addEventListener('change', toggle);
    toggle();
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    try {
      const response = await fetch("{{ url_for('ops.cars_status') }}", { method: 'POST', body: fd });
      const data = await response.json().catch(() => null);
      if (!response.ok) {
        const msg = data && data.errors ? (Array.isArray(data.errors) ? data.errors.join(' / ') : data.errors) : "{{ _('Save failed') }}";
        result.textContent = msg;
        result.className = 'ml-3 text-sm text-red-700';
        return;
      }
      const count = data && typeof data.updated === 'number' ? data.updated : 0;
      result.textContent = `${count} {{ _('vehicles updated') }}`;
      result.className = 'ml-3 text-sm text-green-700';
    } catch (err) {
      result.textContent = '{{ _('Save failed') }}';
      result.className = 'ml-3 text-sm text-red-700';
    }
  });
</script>
{% endblock %}
