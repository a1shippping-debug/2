{% extends "layout.html" %}
{% block title %}{{ _('Edit Car') if vehicle else _('Add Car') }}{% endblock %}
{% block content %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

  body {
    font-family: 'Cairo', sans-serif;
    background-color: #ffffff;
    color: #1E2BA0;
  }

  .car-form-container {
    max-width: 1100px;
    margin: auto;
    padding: 2.5rem 1rem;
  }

  .car-form-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .car-form-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .car-form-header p {
    color: #64748b;
  }

  /* ---------- Form Layout ---------- */
  form.car-form,
  .upload-docs-form {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
  }

  form.car-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
    gap: 1.2rem;
  }

  label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    display: block;
  }

  input,
  select {
    width: 100%;
    border: 1px solid #cbd5e1;
    border-radius: 0.6rem;
    padding: 0.7rem 0.9rem;
    font-size: 0.95rem;
  }

  input:focus,
  select:focus {
    border-color: #1E2BA0;
    outline: none;
  }

  /* ---------- Submit Button ---------- */
  .submit-btn {
    grid-column: 1 / -1;
    padding: 1rem;
    background-color: #1E2BA0;
    color: white;
    border: none;
    border-radius: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: .3s ease;
  }
  .submit-btn:hover { background-color: #2734c2; }

  /* ---------- Upload Section ---------- */
  .upload-section {
    grid-column: 1 / -1;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 0.8rem;
    padding: 1.2rem;
  }

  .upload-section input { margin-top: 0.5rem; }

  /* ---------- Searchable Dropdown ---------- */
  .searchable-dropdown { position: relative; }
  .results {
    position: absolute;
    left: 0; right: 0;
    top: calc(100% + 4px);
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.6rem;
    max-height: 260px;
    overflow-y: auto;
    z-index: 30;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  }
  .item {
    padding: 0.6rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
  }
  .item:hover,
  .item.active {
    background: #eef2ff;
  }
  .meta { color: #64748b; font-size: 0.85rem; }
</style>

<div class="car-form-container">

  <!-- Header -->
  <div class="car-form-header">
    <h1>{{ _('Edit Car') if vehicle else _('Add Car') }}</h1>
    <p>قم بإدخال بيانات السيارة بدقة لتحديث السجلات.</p>
  </div>

  <!-- MAIN FORM -->
  <form id="car_form" method="post" enctype="multipart/form-data" class="car-form">

    <!-- VIN -->
    <div>
      <label>رقم الشاصي (VIN)</label>
      <input name="vin" placeholder="مثال: 1HGCM82633A123456"
             value="{{ vehicle.vin if vehicle else '' }}"
             {% if vehicle %}readonly{% endif %}>
    </div>

    <div><label>الشركة المصنعة</label><input name="make" value="{{ vehicle.make if vehicle else '' }}"></div>
    <div><label>الموديل</label><input name="model" value="{{ vehicle.model if vehicle else '' }}"></div>
    <div><label>السنة</label><input name="year" value="{{ vehicle.year if vehicle else '' }}"></div>

    <div><label>رقم اللوت</label><input name="lot_number" value="{{ vehicle.auction.lot_number if vehicle and vehicle.auction else '' }}"></div>

    <!-- Auction Type -->
    <div>
      <label>نوع المزاد</label>
      <select name="auction_type">
        <option value="">اختر نوع المزاد</option>
        {% for a in ['Copart','IAAI'] %}
        <option value="{{ a }}" {% if vehicle and vehicle.auction and vehicle.auction.provider==a %}selected{% endif %}>
          {{ a }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div><label>الموقع الحالي</label><input name="current_location" value="{{ vehicle.current_location if vehicle else '' }}"></div>

    <div>
      <label>تاريخ الشراء</label>
      <input type="date" name="purchase_date"
             value="{{ vehicle.purchase_date.strftime('%Y-%m-%d') if vehicle and vehicle.purchase_date else '' }}">
    </div>

    <div>
      <label>سعر المزاد شامل الرسوم (USD)</label>
      <input name="auction_total_usd" id="auction_total_usd"
             value="{{ vehicle.purchase_price_usd if vehicle else '' }}">
    </div>

    <!-- Region Select -->
    <div>
      <label>المنطقة (المستودع/الوجهة)</label>
      <div class="searchable-dropdown" id="region_selector">
        <input id="region_input" placeholder="اكتب الكود أو اسم المنطقة" autocomplete="off">
        <div class="results" id="region_results" hidden></div>
        <input type="hidden" name="region" id="region_hidden">
      </div>
    </div>

    <div>
      <label>تكلفة الشحن حسب المنطقة (OMR)</label>
      <input name="shipping_price_omr" id="shipping_price_omr" readonly>
    </div>

    <!-- Clients -->
    <div>
      <label>العميل</label>

      <input id="client_search" list="customers_datalist" placeholder="ابحث باسم العميل"
             value="{{ vehicle.owner.display_name if vehicle and vehicle.owner else '' }}">

      <datalist id="customers_datalist">
        {% for c in customers %}
        <option value="{{ c.display_name }}" data-id="{{ c.id }}" data-category="{{ c.price_category }}"></option>
        {% endfor %}
      </datalist>

      <select name="client_id" id="client_select" class="mt-2">
        <option value="">اختر العميل</option>
        {% for c in customers %}
        <option value="{{ c.id }}" data-category="{{ c.price_category }}"
                {% if vehicle and vehicle.owner_customer_id==c.id %}selected{% endif %}>
          {{ c.display_name }}
        </option>
        {% endfor %}
      </select>

      <input type="hidden" id="price_category_active"
             value="{{ vehicle.owner.price_category if vehicle and vehicle.owner else '' }}">
    </div>

    <!-- Buyer -->
    <div>
      <label>الباير</label>
      <select name="buyer_id" id="buyer_select">
        <option value="">اختر الباير</option>
        {% for b in buyers or [] %}
        <option value="{{ b.id }}"
                {% if vehicle and vehicle.auction and vehicle.auction.buyer_id==b.id %}selected{% endif %}>
          {{ b.name }} {% if b.buyer_number %} — {{ b.buyer_number }}{% endif %}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Status -->
    <div>
      <label>الحالة</label>
      <select name="status">
        {% for s in [
          'New car','Cashier Payment','Auction Payment','Posted','Towing','Warehouse',
          'Loading','Shipping','Port','On way','Arrived','Delivered'] %}
        <option value="{{ s }}" {% if vehicle and vehicle.status==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Warehouse -->
    <div>
      <label>{{ _('Warehouse') }}</label>
      <select name="warehouse_id">
        <option value="">{{ _('Unassigned') }}</option>
        {% for wh in warehouses or [] %}
        <option value="{{ wh.id }}" {% if vehicle and vehicle.warehouse_id==wh.id %}selected{% endif %}>
          {{ wh.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Warehouse arrival -->
    <div>
      <label>{{ _('Warehouse arrival date') }}</label>
      <input type="date" name="warehouse_arrived_at"
             value="{{ vehicle.warehouse_arrived_at.strftime('%Y-%m-%d') if vehicle and vehicle.warehouse_arrived_at else '' }}">
    </div>

    <!-- Keys -->
    <div>
      <label class="block">{{ _('Keys received in warehouse') }}</label>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-2 text-sm text-slate-600">
          <input type="checkbox" name="warehouse_has_keys" value="1"
                 {% if vehicle and vehicle.warehouse_has_keys %}checked{% endif %}>
          <span>{{ _('Keys on hand') }}</span>
        </label>

        <div>
          <span class="text-xs text-slate-500 block mb-1">{{ _('Key count') }}</span>
          <input type="number" min="0" name="warehouse_key_count"
                 value="{{ vehicle.warehouse_key_count if vehicle and vehicle.warehouse_key_count is not none else '' }}"
                 class="w-24">
        </div>
      </div>
    </div>

    <!-- Title Documents -->
    <div>
      <label class="block">{{ _('Warehouse title documents') }}</label>
      <label class="inline-flex items-center gap-2 text-sm text-slate-600">
        <input type="checkbox" name="warehouse_title_received" value="1"
               {% if vehicle and vehicle.warehouse_title_received %}checked{% endif %}>
        <span>{{ _('Title documents received') }}</span>
      </label>

      <div class="mt-2">
        <span class="text-xs text-slate-500 block mb-1">{{ _('Title received date') }}</span>
        <input type="date" name="warehouse_title_received_at"
               value="{{ vehicle.warehouse_title_received_at.strftime('%Y-%m-%d') if vehicle and vehicle.warehouse_title_received_at else '' }}">
      </div>
    </div>

    <!-- Title on hand -->
    <div>
      <label class="inline-flex items-center gap-2">
        <input type="checkbox" name="has_title" value="1"
               {% if vehicle and vehicle.has_title %}checked{% endif %}>
        <span>{{ _('Title on hand') }}</span>
      </label>
      <p class="text-xs text-slate-500 mt-1">
        {{ _('Mark if the original title document has been received for this vehicle.') }}
      </p>
    </div>

    <!-- Tracking -->
    <div>
      <label>{{ _('Title tracking number') }}</label>
      <input name="title_tracking_number"
             value="{{ vehicle.title_tracking_number if vehicle else '' }}"
             placeholder="مثال: DHL123456789">
    </div>

    <div>
      <label>{{ _('Shipping tracking link') }}</label>
      <input type="url" name="shipping_tracking_url"
             value="{{ vehicle.shipping_tracking_url if vehicle else '' }}"
             placeholder="https://example.com/tracking">
    </div>

    <div><label>رقم الحاوية</label><input name="container_number"
             value="{{ vehicle.container_number if vehicle else '' }}"></div>

    <div><label>رقم الحجز</label><input name="booking_number"
             value="{{ vehicle.booking_number if vehicle else '' }}"></div>

    {% if not vehicle %}
    <div class="upload-section">
      <label>رفع صور السيارة</label>
      <input type="file" name="photos" multiple>
    </div>

    <div class="upload-section">
      <label>إرفاق فاتورة المزاد</label>
      <input type="file" name="auction_invoice" accept="application/pdf,image/*">
    </div>
    {% endif %}

    <button class="submit-btn">{{ _('Save') }}</button>

  </form>

  {% if vehicle %}
  <form action="{{ url_for('ops.cars_upload', vehicle_id=vehicle.id) }}"
        method="post" enctype="multipart/form-data"
        class="upload-docs-form mt-4">
    <label class="block mb-2 text-slate-600">رفع مستندات إضافية</label>
    <input type="file" name="files" multiple class="border p-2 rounded w-full mb-3">
    <button>{{ _('Upload') }}</button>
  </form>
  {% endif %}
</div>

<!-- ===== JavaScript (unchanged logic - only formatted) ===== -->
<script>
/* ------ Client Search Logic ------ */
(function() {
  const input = document.getElementById('client_search');
  const select = document.getElementById('client_select');
  const datalist = document.getElementById('customers_datalist');
  const categoryField = document.getElementById('price_category_active');
  if (!input || !select || !datalist) return;

  function updateCategory(cat) {
    const normalized = (cat || '').trim().toLowerCase();
    if (categoryField) categoryField.value = normalized;
    window.dispatchEvent(new CustomEvent('price-category-change', { detail: { category: normalized } }));
  }

  function findOptionByName(name) {
    return Array.from(datalist.options).find(o =>
      o.value.trim().toLowerCase() === name.trim().toLowerCase()
    );
  }

  function applyOption(option) {
    if (!option) return updateCategory('');
    select.value = option.dataset.id;
    updateCategory(option.dataset.category);
  }

  input.addEventListener('change', () => {
    applyOption(findOptionByName(input.value));
  });

  select.addEventListener('change', () => {
    const opt = select.selectedOptions[0];
    updateCategory(opt.dataset.category);
    input.value = opt.textContent;
  });

  if (select.value) {
    const opt = select.selectedOptions[0];
    updateCategory(opt.dataset.category);
    input.value = findOptionByName(opt.textContent)?.value || '';
  }
})();

/* ------ Region Selector + Auto Price ------ */
(function() {
  const input = document.getElementById('region_input');
  const list = document.getElementById('region_results');
  const hidden = document.getElementById('region_hidden');
  const priceField = document.getElementById('shipping_price_omr');

  if (!input || !list || !priceField) return;

  let items = [];
  let activeIndex = -1;
  let lastQuery = '';
  let fetchTimeout;

  async function fetchSuggestions(q) {
    const cat = document.getElementById('price_category_active').value;
    let url = `{{ url_for('ops.shipping_regions_suggest') }}?q=${encodeURIComponent(q)}&limit=12`;
    if (cat) url += '&category=' + encodeURIComponent(cat);

    const resp = await fetch(url);
    items = resp.ok ? await resp.json() : [];
    activeIndex = items.length ? 0 : -1;
    render();
  }

  async function fetchPrice(val) {
    if (!val) return;
    const cat = document.getElementById('price_category_active').value;

    let url = `{{ url_for('ops.shipping_region_price') }}?q=${encodeURIComponent(val)}`;
    if (cat) url += '&category=' + encodeURIComponent(cat);

    const resp = await fetch(url);
    if (!resp.ok) return priceField.value = '';

    const data = await resp.json();
    if (data.found) {
      priceField.value = data.price_omr;
      hidden.value = data.region_code;
    }
  }

  function render() {
    list.innerHTML = '';
    if (!items.length) return list.hidden = true;

    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'item' + (idx === activeIndex ? ' active' : '');
      div.innerHTML = `
        <span>${it.region_code}</span>
        <span class="meta">${it.region_name} · ${Number(it.price_omr).toFixed(3)} OMR</span>
      `;
      div.addEventListener('mousedown', e => {
        e.preventDefault();
        choose(idx);
      });
      list.appendChild(div);
    });

    list.hidden = false;
  }

  function choose(i) {
    const it = items[i];
    input.value = it.region_code;
    hidden.value = it.region_code;
    priceField.value = it.price_omr;
    list.hidden = true;
  }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    if (q === lastQuery) return;
    lastQuery = q;

    if (!q) return (items = [], render());
    clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(() => fetchSuggestions(q), 160);
  });

  input.addEventListener('blur', () => {
    setTimeout(() => {
      list.hidden = true;
      fetchPrice(input.value);
    }, 120);
  });
})();
</script>

{% endblock %}
