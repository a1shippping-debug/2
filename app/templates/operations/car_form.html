{% extends "layout.html" %}
{% block title %}{{ _('Edit Car') if vehicle else _('Add Car') }}{% endblock %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">{{ _('Edit Car') if vehicle else _('Add Car') }}</h1>
<form method="post" enctype="multipart/form-data" class="bg-white p-4 rounded shadow grid grid-cols-1 md:grid-cols-3 gap-3">
  <input name="vin" placeholder="{{ _('VIN') }}" value="{{ vehicle.vin if vehicle else '' }}" class="border p-2 rounded md:col-span-1" {% if vehicle %}readonly{% endif %}>
  <input name="make" placeholder="{{ _('Make') }}" value="{{ vehicle.make if vehicle else '' }}" class="border p-2 rounded">
  <input name="model" placeholder="{{ _('Model') }}" value="{{ vehicle.model if vehicle else '' }}" class="border p-2 rounded">
  <input name="year" placeholder="{{ _('Year') }}" value="{{ vehicle.year if vehicle else '' }}" class="border p-2 rounded">

  <input name="lot_number" placeholder="{{ _('Lot Number') }}" value="{{ vehicle.auction.lot_number if vehicle and vehicle.auction else '' }}" class="border p-2 rounded">
  <select name="auction_type" class="border p-2 rounded">
    <option value="">{{ _('Auction Type') }}</option>
    {% for a in ['Copart','IAAI'] %}
      <option value="{{ a }}" {% if vehicle and vehicle.auction and vehicle.auction.provider==a %}selected{% endif %}>{{ a }}</option>
    {% endfor %}
  </select>

  <div class="md:col-span-2 flex gap-2">
    <input id="auction_url" name="auction_url" placeholder="{{ _('Auction Link') }}" value="{{ vehicle.auction.auction_url if vehicle and vehicle.auction else '' }}" class="border p-2 rounded flex-1">
    <button type="button" id="fetch_bidcars" class="px-3 py-2 bg-emerald-600 text-white rounded whitespace-nowrap">{{ _('Auto-Fill') }}</button>
  </div>
  <input name="current_location" placeholder="{{ _('Current Location') }}" value="{{ vehicle.current_location if vehicle else '' }}" class="border p-2 rounded">

  <input type="date" name="purchase_date" class="border p-2 rounded">
  <input name="purchase_price" placeholder="{{ _('Purchase Price (USD)') }}" class="border p-2 rounded">
  <input name="auction_fees" placeholder="{{ _('Auction Fees') }}" class="border p-2 rounded">
  <input name="local_transport" placeholder="{{ _('Local Transport Cost') }}" class="border p-2 rounded">

  <select name="client_id" class="border p-2 rounded">
    <option value="">{{ _('Client') }}</option>
    {% for c in customers %}
      <option value="{{c.id}}" {% if vehicle and vehicle.owner_customer_id==c.id %}selected{% endif %}>{{ c.company_name or c.full_name }}</option>
    {% endfor %}
  </select>
  <select name="status" class="border p-2 rounded">
    {% for s in ['Purchased','Shipped','In Transit','Arrived','Cleared','Delivered'] %}
      <option value="{{s}}" {% if vehicle and vehicle.status==s %}selected{% endif %}>{{ s }}</option>
    {% endfor %}
  </select>

  {% if not vehicle %}
  <div class="md:col-span-3">
    <label class="block text-sm mb-1">{{ _('Upload Photos') }}</label>
    <input type="file" name="photos" multiple class="border p-2 rounded w-full">
  </div>
  {% endif %}

  <div class="md:col-span-3">
    <button class="px-4 py-2 bg-blue-600 text-white rounded">{{ _('Save') }}</button>
  </div>
</form>
{% if vehicle %}
<form action="{{ url_for('ops.cars_upload', vehicle_id=vehicle.id) }}" method="post" enctype="multipart/form-data" class="bg-white p-4 rounded shadow mt-4">
  <div class="mb-2"><label class="text-sm">{{ _('Upload Documents') }}</label></div>
  <input type="file" name="files" multiple class="border p-2 rounded w-full mb-2">
  <button class="px-3 py-2 bg-gray-800 text-white rounded">{{ _('Upload') }}</button>
</form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function(){
  const btn = document.getElementById('fetch_bidcars');
  if (!btn) return;
  btn.addEventListener('click', async function() {
    const urlInput = document.getElementById('auction_url');
    const url = (urlInput && urlInput.value || '').trim();
    if (!url) { alert('Paste BidCars link first'); return; }
    btn.disabled = true; const old = btn.textContent; btn.textContent = '...';
    try {
      const resp = await fetch('{{ url_for('ops.cars_fetch_from_bidcars') }}', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url })
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) { alert(data.error || 'Failed to parse'); return; }
      const setVal = (name, val) => { const el = document.querySelector(`[name="${name}"]`); if (el && !el.value && val != null) el.value = val; };
      setVal('vin', data.vin || '');
      setVal('make', data.make || '');
      setVal('model', data.model || '');
      setVal('year', data.year || '');
      setVal('lot_number', data.lot_number || '');
      // provider -> auction_type select
      if (data.provider) {
        const sel = document.querySelector('[name="auction_type"]');
        if (sel) {
          for (const opt of sel.options) { if ((opt.value || '').toLowerCase() === data.provider.toLowerCase()) { opt.selected = true; break; } }
        }
      }
    } catch (e) {
      alert('Network error');
    } finally {
      btn.disabled = false; btn.textContent = old;
    }
  });
})();
</script>
{% endblock %}
