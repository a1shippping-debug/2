{% extends "layout.html" %}
{% block title %}{{ _('Edit Car') if vehicle else _('Add Car') }}{% endblock %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">{{ _('Edit Car') if vehicle else _('Add Car') }}</h1>
<form id="car_form" method="post" enctype="multipart/form-data" class="bg-white p-4 rounded shadow grid grid-cols-1 md:grid-cols-3 gap-3">
  
  <input name="vin" placeholder="{{ _('VIN') }}" value="{{ vehicle.vin if vehicle else '' }}" class="border p-2 rounded md:col-span-1" {% if vehicle %}readonly{% endif %}>
  <input name="make" placeholder="{{ _('Make') }}" value="{{ vehicle.make if vehicle else '' }}" class="border p-2 rounded">
  <input name="model" placeholder="{{ _('Model') }}" value="{{ vehicle.model if vehicle else '' }}" class="border p-2 rounded">
  <input name="year" placeholder="{{ _('Year') }}" value="{{ vehicle.year if vehicle else '' }}" class="border p-2 rounded">

  <input name="lot_number" placeholder="{{ _('Lot Number') }}" value="{{ vehicle.auction.lot_number if vehicle and vehicle.auction else '' }}" class="border p-2 rounded">
  <select name="auction_type" class="border p-2 rounded">
    <option value="">{{ _('Auction Type') }}</option>
    {% for a in ['Copart','IAAI'] %}
      <option value="{{ a }}" {% if vehicle and vehicle.auction and vehicle.auction.provider==a %}selected{% endif %}>{{ a }}</option>
    {% endfor %}
  </select>

  
  <input name="current_location" placeholder="{{ _('Current Location') }}" value="{{ vehicle.current_location if vehicle else '' }}" class="border p-2 rounded">

  <input type="date" name="purchase_date" class="border p-2 rounded">
  <input name="purchase_price" placeholder="{{ _('Purchase Price (USD)') }}" class="border p-2 rounded">
  <input name="auction_fees" placeholder="{{ _('Auction Fees') }}" class="border p-2 rounded">
  <input name="local_transport" placeholder="{{ _('Local Transport Cost') }}" class="border p-2 rounded">

  <div class="md:col-span-1">
    <label class="block text-sm mb-1">العميل</label>
    <input id="client_search" list="customers_datalist" placeholder="اكتب اسم العميل للبحث" value="{{ (vehicle.owner.company_name or vehicle.owner.full_name) if (vehicle and vehicle.owner) else '' }}" class="border p-2 rounded w-full">
    <datalist id="customers_datalist">
      {% for c in customers %}
        <option value="{{ c.company_name or c.full_name }}" data-id="{{ c.id }}"></option>
      {% endfor %}
    </datalist>
    <select name="client_id" id="client_select" class="border p-2 rounded w-full mt-2">
      <option value="">{{ 'اختر العميل' }}</option>
      {% for c in customers %}
        <option value="{{ c.id }}" {% if vehicle and vehicle.owner_customer_id==c.id %}selected{% endif %}>{{ c.company_name or c.full_name }}</option>
      {% endfor %}
    </select>
  </div>
  <select name="status" class="border p-2 rounded">
    {% for s in ['New car','Cashier Payment','Auction Payment','Posted','Towing','Warehouse','Loading','Shipping','Port','On way','Arrived','Delivered'] %}
      <option value="{{s}}" {% if vehicle and vehicle.status==s %}selected{% endif %}>{{ s }}</option>
    {% endfor %}
  </select>

  {% if not vehicle %}
  <div class="md:col-span-3">
    <label class="block text-sm mb-1">{{ _('Upload Photos') }}</label>
    <input type="file" name="photos" multiple class="border p-2 rounded w-full">
  </div>
  {% endif %}

  <div class="md:col-span-3">
    <button class="px-4 py-2 bg-blue-600 text-white rounded">{{ _('Save') }}</button>
  </div>
</form>
{% if vehicle %}
<form action="{{ url_for('ops.cars_upload', vehicle_id=vehicle.id) }}" method="post" enctype="multipart/form-data" class="bg-white p-4 rounded shadow mt-4">
  <div class="mb-2"><label class="text-sm">{{ _('Upload Documents') }}</label></div>
  <input type="file" name="files" multiple class="border p-2 rounded w-full mb-2">
  <button class="px-3 py-2 bg-gray-800 text-white rounded">{{ _('Upload') }}</button>
</form>
{% endif %}
<script>
(function() {
  const input = document.getElementById('client_search');
  const select = document.getElementById('client_select');
  const datalist = document.getElementById('customers_datalist');
  if (!input || !select || !datalist) return;
  function selectByName(name) {
    const options = Array.from(datalist.options || []);
    const match = options.find(function(opt) {
      return (opt.value || '').trim().toLowerCase() === (name || '').trim().toLowerCase();
    });
    if (match && match.dataset && match.dataset.id) {
      select.value = match.dataset.id;
    }
  }
  input.addEventListener('change', function() {
    selectByName(input.value);
  });
  select.addEventListener('change', function() {
    const opt = Array.from(datalist.options || []).find(function(o) {
      return (o.dataset && o.dataset.id) === select.value;
    });
    if (opt) {
      input.value = opt.value;
    }
  });
})();
</script>
{% endblock %}


