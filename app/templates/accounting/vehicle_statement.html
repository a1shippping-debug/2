{% extends "base_accounting.html" %}
{% block acct_content %}
<h2 class="text-2xl font-bold text-blue-900 mb-4">{{ _('Vehicle Statement of Account') }}</h2>
<div class="mb-4 grid md:grid-cols-2 gap-4 text-sm">
  <div>
    <div><strong>VIN:</strong> <span class="font-mono">{{ vehicle.vin }}</span></div>
    <div><strong>{{ _('Client') }}:</strong> {{ vehicle.owner.company_name if vehicle.owner else '-' }}</div>
    <div><strong>{{ _('Auction Lot') }}:</strong> {{ vehicle.auction.lot_number if vehicle.auction else '-' }}</div>
  </div>
  <div>
    <div><strong>{{ _('Status') }}:</strong> {{ vehicle.status or '-' }}</div>
    <div><strong>{{ _('Current Location') }}:</strong> {{ vehicle.current_location or '-' }}</div>
    <div><strong>{{ _('Purchase Date') }}:</strong> {{ vehicle.purchase_date.strftime('%Y-%m-%d') if vehicle.purchase_date else '-' }}</div>
  </div>
</div>

<table class="w-full table-auto text-sm">
  <thead>
    <tr class="text-left text-slate-500">
      <th class="py-2">{{ _('Date') }}</th>
      <th>{{ _('Description') }}</th>
      <th>{{ _('Account') }}</th>
      <th class="text-right">{{ _('Debit') }}</th>
      <th class="text-right">{{ _('Credit') }}</th>
      <th class="text-right">{{ _('Balance') }}</th>
    </tr>
  </thead>
  <tbody id="statement-body">
    {% for r in statement %}
    <tr class="border-t">
      <td class="py-1">{{ r.date }}</td>
      <td>{{ r.description }}</td>
      <td class="font-mono">{{ r.account_code }} — {{ r.account_name }}</td>
      <td class="text-right">{{ '%.3f'|format(r.debit) }}</td>
      <td class="text-right">{{ '%.3f'|format(r.credit) }}</td>
      <td class="text-right">{{ '%.3f'|format(r.balance) }}</td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="py-4 text-center text-slate-400">{{ _('No transactions yet') }}</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="mt-6 grid md:grid-cols-3 gap-4">
  <div class="bg-slate-50 border rounded p-3">
    <div class="text-slate-500 text-xs">{{ _('Auction Cost') }}</div>
    <div id="total-auction-cost" class="text-lg font-semibold">{{ '%.3f'|format(totals.auction_cost_omr) }}</div>
  </div>
  <div class="bg-slate-50 border rounded p-3">
    <div class="text-slate-500 text-xs">{{ _('Freight') }}</div>
    <div id="total-freight" class="text-lg font-semibold">{{ '%.3f'|format(totals.freight_omr) }}</div>
  </div>
  <div class="bg-slate-50 border rounded p-3">
    <div class="text-slate-500 text-xs">{{ _('Customs') }}</div>
    <div id="total-customs" class="text-lg font-semibold">{{ '%.3f'|format(totals.customs_omr) }}</div>
  </div>
  <div class="bg-slate-50 border rounded p-3">
    <div class="text-slate-500 text-xs">{{ _('Service Fee') }}</div>
    <div id="total-service-fee" class="text-lg font-semibold">{{ '%.3f'|format(totals.service_fee_omr) }}</div>
  </div>
  <div class="bg-slate-50 border rounded p-3">
    <div class="text-slate-500 text-xs">{{ _('Deposit Net') }}</div>
    <div id="total-deposit-net" class="text-lg font-semibold">{{ '%.3f'|format(totals.deposit_net_omr) }}</div>
  </div>
  <div class="bg-slate-50 border rounded p-3">
    <div class="text-slate-500 text-xs">{{ _('Outstanding Balance') }}</div>
    <div id="total-outstanding" class="text-lg font-semibold">{{ '%.3f'|format(totals.outstanding_balance_omr) }}</div>
  </div>
</div>

<div class="mt-6 flex gap-2">
  <a class="px-3 py-1.5 bg-slate-200 rounded" href="{{ url_for('acct.vehicles_list') }}">{{ _('Back') }}</a>
  <a class="px-3 py-1.5 bg-blue-600 text-white rounded" href="{{ url_for('acct.vehicle_statement_pdf', vehicle_id=vehicle.id) }}">{{ _('Export PDF') }}</a>
  <button type="button" id="btn-refresh" class="px-3 py-1.5 bg-slate-100 rounded border">{{ _('Refresh') }}</button>
</div>

<script>
  (function(){
    const fmt = (n) => {
      try { return (Number(n || 0)).toFixed(3); } catch(e) { return '0.000'; }
    };
    const tbody = document.getElementById('statement-body');
    const url = '{{ url_for('acct.api_vehicle_statement', vehicle_id=vehicle.id) }}';
    async function refreshStatement(){
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) return;
        const data = await res.json();
        // Update rows
        if (tbody) {
          if (data.entries && data.entries.length) {
            tbody.innerHTML = data.entries.map(r => (
              `<tr class="border-t">`
              + `<td class="py-1">${r.date || ''}</td>`
              + `<td>${(r.description || '').replace(/</g,'&lt;')}</td>`
              + `<td class="font-mono">${r.account_code || ''} — ${(r.account_name || '').replace(/</g,'&lt;')}</td>`
              + `<td class="text-right">${fmt(r.debit)}</td>`
              + `<td class="text-right">${fmt(r.credit)}</td>`
              + `<td class="text-right">${fmt(r.balance)}</td>`
              + `</tr>`
            )).join('');
          } else {
            tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-slate-400">{{ _('No transactions yet') }}</td></tr>`;
          }
        }
        // Update totals
        const t = data.totals || {};
        const byId = (id) => document.getElementById(id);
        const pairs = [
          ['total-auction-cost', t.auction_cost_omr],
          ['total-freight', t.freight_omr],
          ['total-customs', t.customs_omr],
          ['total-service-fee', t.service_fee_omr],
          ['total-deposit-net', t.deposit_net_omr],
          ['total-outstanding', t.outstanding_balance_omr],
        ];
        for (const [id, val] of pairs) {
          const el = byId(id); if (el) el.textContent = fmt(val);
        }
      } catch(e) { /* silent */ }
    }
    document.getElementById('btn-refresh')?.addEventListener('click', refreshStatement);
    // Auto refresh every 30s
    setInterval(refreshStatement, 30000);
  })();
</script>
{% endblock %}
