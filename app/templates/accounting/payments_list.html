{% extends "base_accounting.html" %}
{% block acct_content %}

<div class="grid md:grid-cols-3 gap-6">
  <!-- جدول الدفعات -->
  <div class="md:col-span-2">
    <h2 class="text-2xl font-bold text-blue-900 mb-4">{{ _('Payments') }}</h2>

    <div class="overflow-x-auto bg-white border border-gray-200 rounded-2xl shadow-sm">
      <table class="min-w-full text-sm text-gray-700">
        <thead class="bg-blue-50 text-blue-900 font-semibold">
          <tr>
            <th class="px-4 py-3 text-left">{{ _('Invoice') }}</th>
            <th class="px-4 py-3 text-left">VIN</th>
            <th class="px-4 py-3 text-left">{{ _('Customer') }}</th>
            <th class="px-4 py-3 text-left">{{ _('Amount (OMR)') }}</th>
            <th class="px-4 py-3 text-left">{{ _('Method') }}</th>
            <th class="px-4 py-3 text-left">{{ _('Date') }}</th>
          </tr>
        </thead>

        <tbody>
          {% for p in payments %}
          <tr class="border-t border-gray-100 hover:bg-blue-50 transition">
            <td class="px-4 py-3 font-medium text-gray-800">
              {{ p.invoice.invoice_number if p.invoice else '-' }}
            </td>
            <td class="px-4 py-3">
              {{ p.vehicle.vin if p.vehicle else (p.invoice.vehicle.vin if p.invoice and p.invoice.vehicle else '-') }}
            </td>
            <td class="px-4 py-3">
              {{ p.customer.display_name if p.customer else (p.invoice.customer.display_name if p.invoice and p.invoice.customer else '-') }}
            </td>
            <td class="px-4 py-3">{{ '%.3f'|format(p.amount_omr or 0) }}</td>
            <td class="px-4 py-3">{{ p.method }}</td>
            <td class="px-4 py-3">{{ p.received_at.strftime('%Y-%m-%d') if p.received_at else '' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="px-4 py-6 text-center text-gray-400">
              {{ _('No payments.') }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- نموذج تسجيل دفعة -->
  <div>
    <h3 class="text-xl font-semibold text-blue-900 mb-3">{{ _('Record Payment') }}</h3>

    <form id="payment-form" method="post" action="{{ url_for('acct.payments_new') }}"
          class="space-y-3 bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">

      <input type="hidden" name="invoice_id" id="invoice_id" />

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">رقم الشاصي (VIN)</label>
        <input name="vin" id="vin_input" placeholder="مثال: 1HGCM82633A123456"
               class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" />
        <div class="text-xs text-gray-500 mt-1">أدخل الشاصي وسيتم جلب الفاتورة تلقائياً.</div>
      </div>

      <div id="invoice_preview" class="hidden border rounded-lg p-3 bg-gray-50 text-sm"></div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">{{ _('Amount (OMR)') }}</label>
        <input name="amount" type="number" step="0.001" id="amount_input"
               class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">نوع القيد</label>
        <select name="entry_type" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
          <option value="auto">تلقائي</option>
          <option value="client_fund">أموال عميل (قيد وديعة)</option>
          <option value="ar_settlement">سداد ذمم مدينة</option>
          <option value="revenue">إيراد خدمة مباشر</option>
        </select>
        <div class="text-xs text-gray-500 mt-1">عند اختيار "تلقائي" سيتم تحديد نوع القيد حسب نوع الفاتورة.</div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">{{ _('Method') }}</label>
        <select name="method" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
          <option>{{ _('Cash') }}</option>
          <option>{{ _('Bank Transfer') }}</option>
          <option>{{ _('Card') }}</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">{{ _('Reference') }}</label>
        <input name="reference"
               class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <div class="pt-2">
        <button class="w-full py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition">
          {{ _('Save') }}
        </button>
      </div>
    </form>

    <script>
      (function() {
        const vinInput = document.getElementById('vin_input');
        const invIdField = document.getElementById('invoice_id');
        const preview = document.getElementById('invoice_preview');
        const amountInput = document.getElementById('amount_input');

        let timer = null;
        function fmt(num) {
          try { return Number(num || 0).toFixed(3); } catch (e) { return '0.000'; }
        }
        function renderPreview(data) {
          preview.classList.remove('hidden');
          const itemsHtml = (data.items || []).map(it => `<div class="flex justify-between"><span>${it.description}</span><span>${fmt(it.amount_omr)}</span></div>`).join('');
          preview.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <div class="font-semibold text-blue-900">${data.invoice_number || '-'}</div>
                <div class="text-gray-600">${data.customer?.name || '-'} • VIN: ${data.vehicle?.vin || '-'}</div>
              </div>
              <div class="text-right">
                <div>{{ _('Total (OMR)') }}: <strong>${fmt(data.total_omr)}</strong></div>
                <div>{{ _('Paid') }}: ${fmt(data.paid_omr)} • {{ _('Balance') }}: <strong>${fmt(data.balance_omr)}</strong></div>
              </div>
            </div>
            <div class="mt-2 border-t pt-2 space-y-1">${itemsHtml}</div>
          `;
        }

        async function lookup() {
          const vin = (vinInput.value || '').trim();
          invIdField.value = '';
          preview.classList.add('hidden');
          preview.innerHTML = '';
          if (!vin) return;
          try {
            const resp = await fetch(`{{ url_for('acct.api_invoice_by_vin') }}?vin=${encodeURIComponent(vin)}`, { credentials: 'same-origin' });
            if (!resp.ok) {
              return;
            }
            const data = await resp.json();
            if (data && data.invoice_id) {
              invIdField.value = String(data.invoice_id);
              renderPreview(data);
              if (Number(amountInput.value || 0) <= 0 && Number(data.balance_omr || 0) > 0) {
                amountInput.value = Number(data.balance_omr || 0).toFixed(3);
              }
            }
          } catch (e) {
            // silent fail
          }
        }

        function scheduleLookup() {
          if (timer) clearTimeout(timer);
          timer = setTimeout(lookup, 400);
        }

        vinInput.addEventListener('input', scheduleLookup);
        vinInput.addEventListener('blur', lookup);
      })();
    </script>
  </div>
</div>

{% endblock %}
